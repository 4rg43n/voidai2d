using System.Collections.Generic;
using UnityEngine;
using VoidAI.Pathfinding;

[System.Serializable]
public class TileCell:IAStarNode
{
    public WorldGenerator world;

    public Vector2Int Position;
    public Vector3 WorldPosition;
    public int areaValue = -1; // comes from the WorldGeneration area array

    public GridObject Contents { get { return contents; } }

    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    public int X => Position.x;

    public int Y => Position.y;

    public bool IsWalkable => areaValue > 0 && contents == null;

    public float Distance => 1;

    public float G { get; set; }
    public float H { get; set; }

    public float F => G + H;

    public IAStarNode Parent { get; set; }
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    GridObject contents;

    public void ClearContents()
    {
        if (contents!=null)
        {
            contents = null;
        }
    }

    public void SetContents(GridObject gridObj)
    {
        if (Contents!=null)
        {
            Debug.LogError("Tried to enter location, but location is not empty. Ignoring. Position:"+Position);
            return;
        }

        contents = gridObj;
        contents.transform.position = WorldPosition + (Vector3)gridObj.OriginOffset;
    }

    public virtual void OnSelect()
    {
        if (contents != null)
            contents.OnSelect();
    }

    public virtual void OnDeselect()
    {
        if (contents != null)
            contents.OnDeselect();
    }

    public virtual void OnSelectPath() { }
    public virtual void OnDeselectPath() { }
    public virtual void OnSelectArea() { }
    public virtual void OnDeselectArea() { }

    public override string ToString()
    {
        return "TileCell-(" + Position.x + ", " + Position.y + ")";
    }

    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    public IEnumerable<IAStarNode> GetNeighbors4()
    {
        Vector2Int[] deltas = new Vector2Int[]
        {
            new Vector2Int(0,1),
            new Vector2Int(1,0),
            new Vector2Int(0,-1),
            new Vector2Int(-1,0)
        };

        List<IAStarNode> neighbors = new List<IAStarNode>();
        foreach (var d in deltas)
        {
            var nbPos = Position + d;
            var nb = world.GetCellAtPosition(nbPos);
            if (nb != null)
                neighbors.Add(nb);
        }

        return neighbors;
    }

    public IAStarNode GetNodeAt(int x, int y)
    {
        return world.GetCellAtPosition(new Vector2Int(x, y));
    }
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
}
